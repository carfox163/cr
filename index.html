<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Vocabulary Challenge</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #f9f5ff;
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

       .header {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #e84393;
            font-size: 1.6em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

       .main-title {
            text-align: left;
            color: #6c5ce7;
            font-size: 2.8em;
            margin: 20px 0 20px;
            letter-spacing: 2px;
            display: inline-block;
        }

        #timer {
            position: relative;
            font-size: 2.5em;
            color: #e84393;
            background: linear-gradient(45deg, #e1f5fe, #f3e5f5);
            /* æµ…è‰²è°ƒå½©è‰²èƒŒæ™¯ */
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: fit-content;
            margin: 0 0 0 20px;
            display: inline-block;
            vertical-align: middle;
        }

       .game-container {
            display: flex;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            z-index: 1;
            position: relative;
        }

       .group {
            flex: 1;
            background: #ffffff;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            position: relative;
        }

       .group-title {
            text-align: center;
            color: #00b894;
            font-size: 1.8em;
            margin: 0 0 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

       .word-box-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

       .word-box {
            background: #ffe0f7;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.6em;
            text-align: center;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.05);
            border: 2px dashed #ff9ff3;
            cursor: pointer; /* æ·»åŠ å…‰æ ‡æ ·å¼ */
            width: 70%; /* è°ƒæ•´å•è¯æ¡†å®½åº¦ */
        }

       .prev-btn,
       .next-btn {
            padding: 18px 8px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px; /* è°ƒæ•´æŒ‰é’®é—´è· */
        }

       .prev-btn:hover,
       .next-btn:hover {
            background: #574b90;
        }

       .bubbles-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

       .bubble {
            min-width: 120px;
            height: 120px;
            background: #81ecec;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            animation: float 2.5s ease-in-out infinite;
            font-size: 1.3em;
            color: #000000;
            border: 2px solid #00cec9;
            text-align: center;
            word-break: break-word;
        }

        @keyframes float {
            0%,
            100% {
                transform: translateY(0) rotate(-2deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

       .start-btn {
            padding: 10px 20px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            display: inline-block;
        }

       .reset-btn {
            padding: 10px 20px;
            background: #e84393;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            display: inline-block;
        }

        #fileInput {
            position: fixed;
            bottom: 25px;
            left: 25px;
            padding: 6px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

       .download-template {
            position: fixed;
            bottom: 27px;
            left: 235px; /* è°ƒæ•´åˆ°æ‰“å¼€æ–‡ä»¶æ¡†å³ä¾§ */
            padding: 8px 15px; /* ç¼©å°æŒ‰é’® */
            border-radius: 8px;
            background: #0984e3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em; /* ç¼©å°å­—ä½“ */
        }

       .review-btn {
            position: fixed;
            bottom: 160px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .result {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
            color: #e84393;
            font-weight: bold;
            padding: 10px;
            background: #fff1f8;
            border-radius: 10px;
        }

       .settings-panel {
            position: fixed;
            bottom: 260px;
            right: 25px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 0;
            width: 100px;
            /* ä¿®æ”¹å®½åº¦ä¸ºç°æœ‰ä¸€åŠ */
        }

       .settings-row {
            margin-bottom: 10px;
        }

       .settings-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #6c5ce7;
            font-size: 0.9em;
        }

       .settings-row input,
       .settings-row select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.9em;
        }

       .mode-selector {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            /* è°ƒæ•´é—´è· */
        }

       .mode-btn {
            padding: 10px 20px;
            background: #fdcb6e;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
        }

       .mode-btn.active {
            background: #6c5ce7;
            transform: scale(1.05);
        }

       .save-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #e84393;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .difficulty-btn {
            position: fixed;
            bottom: 70px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .progress-ring {
            position: fixed;
            top: 22%;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
        }

       .correct-sound,
       .wrong-sound {
            display: none;
        }

       .sound-toggle {
            position: fixed;
            bottom: 115px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #6c5ce7;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .sound-toggle.off {
            background: #b2bec3;
        }

       .groups-selector {
            position: fixed;
            bottom: 205px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00cec9;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1200px) {
           .game-container {
                flex-direction: column;
                max-width: 800px;
            }

           .group {
                margin-bottom: 20px;
            }

           .bubble {
                min-width: 100px;
                height: 100px;
                font-size: 1em;
            }

           .settings-panel {
                bottom: 25px;
                right: 180px;
                width: 90px;
                /* ä¿®æ”¹å“åº”å¼å¸ƒå±€ä¸‹çš„å®½åº¦ */
            }
        }
    </style>
</head>

<body>
    <!-- æ·»åŠ è¶…é“¾æ¥åŒ…è£¹æ–‡å­—ï¼Œä½¿ç”¨ target="_blank" æ–°çª—å£æ‰“å¼€ -->
    <a href="http://2006b.ys168.com" target="_blank">
        <div class="header">by Evita & CreativeLearner v2.4</div>
    </a>
    <!-- å°†å›¾ç‰‡åŒ…è£¹åœ¨ <a> æ ‡ç­¾å†… -->
    <a href="http://2006b.ys168.com" target="_blank">
        <img src="https://s3.bmp.ovh/imgs/2025/05/18/5748f0662563f7e7.png" width="182"
            height="110" style="position: relative;">
    </a>
    <div class="settings-panel">
        <div class="settings-row">
            <label for="gameTime">æŒ‘æˆ˜æ—¶é—´(ç§’):</label>
            <input type="number" id="gameTime" value="60" min="10" max="600">
        </div>
        <div class="settings-row">
            <label for="optionsCount">é€‰é¡¹æ•°é‡:</label>
            <select id="optionsCount">
                <option value="2">2ä¸ªé€‰é¡¹</option>
                <option value="3">3ä¸ªé€‰é¡¹</option>
                <option value="4" selected>4ä¸ªé€‰é¡¹</option>
                <option value="5">5ä¸ªé€‰é¡¹</option>
                <option value="6">6ä¸ªé€‰é¡¹</option>
            </select>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx,.xls">
    <!-- æ–°å¢è¶…é“¾æ¥ -->
    <a href="https://creativelearner.lanzouy.com/b0hd1d0af" target="_blank" style="position: fixed; bottom: 5px; left: 25px; font-family: 'Microsoft YaHei';">æ›´å¤šå•è¯è¡¨ä¸‹è½½>å¯†ç  clearn</a> 
    <button class="download-template" id="downloadTemplate">ä¸‹è½½å•è¯è¡¨æ¨¡æ¿</button>
    <button class="review-btn" id="reviewBtn">å•è¯å¤ä¹ </button>
    <button class="groups-selector" id="groupsSelector">åˆ†ç»„: 2ç»„</button>
    <button class="difficulty-btn" id="difficultyBtn">éš¾åº¦: æ™®é€š</button>
    <button class="sound-toggle" id="soundToggle">éŸ³æ•ˆ: å¼€</button>
    <button class="save-btn" id="saveBtn">ä¿å­˜æˆç»©</button>
    <!-- æ–°å¢çš„è¶…é“¾æ¥ -->
    <a href="https://github.com/carfox163/cr" target="_blank" style="position: fixed; bottom: 5px; right: 15px; font-family: 'Microsoft YaHei';">githubé¡¹ç›®</a>
    <a href="https://creativelearners.netlify.app/" target="_blank" style="position: fixed; bottom: 5px; right: 105px; font-family: 'Microsoft YaHei';">åœ¨çº¿ç‰ˆ</a>

    <h1 class="main-title">Vocabulary Challenge</h1>
    <div id="timer">è®¡æ—¶ï¼š60</div>
    <div class="mode-selector">
        <button class="mode-btn active" data-mode="en-cn">è‹±â†’ä¸­</button>
        <button class="mode-btn" data-mode="cn-en">ä¸­â†’è‹±</button>
        <button class="mode-btn" data-mode="spelling">æ‹¼å†™æµ‹è¯•</button>
        <button class="start-btn" onclick="startGame()">å¼€å§‹</button>
        <button class="reset-btn" onclick="resetGame()">é‡ç½®</button>
    </div>

    <div class="game-container" id="gameContainer">
        <div class="group" id="groupA">
            <h2 class="group-title">Aç»„ å‰©ä½™ï¼š <span id="remainingA">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('A')">â†</button>
                <div class="word-box" id="wordA" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('A')">â†’</button>
            </div>
            <div class="bubbles-container" id="bubblesA"></div>
            <div class="result" id="resultA"></div>
        </div>
        <div class="group" id="groupB">
            <h2 class="group-title">Bç»„ å‰©ä½™ï¼š  <span id="remainingB">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('B')">â†</button>
                <div class="word-box" id="wordB" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('B')">â†’</button>
            </div>
            <div class="bubbles-container" id="bubblesB"></div>
            <div class="result" id="resultB"></div>
        </div>
        <div class="group" id="groupC" style="display: none;">
            <h2 class="group-title">Cç»„ å‰©ä½™ï¼š  <span id="remainingC">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('C')">â†</button>
                <div class="word-box" id="wordC" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('C')">â†’</button>
            </div>
            <div class="bubbles-container" id="bubblesC"></div>
            <div class="result" id="resultC"></div>
        </div>
    </div>

    <!-- éŸ³æ•ˆå…ƒç´  -->
    <audio class="correct-sound">
        <source src="https://cdn.pixabay.com/audio/2021/08/04/audio_c201b79c03.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>
    <audio class="wrong-sound">
        <source src="https://cdn.pixabay.com/audio/2022/03/10/audio_6b59debae7.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>

    <script>
        let wordsData = [];
        let currentWords = { A: null, B: null, C: null };
        let timer;
        let timeLeft = 30;
        let results = {
            A: { correct: 0, wrong: 0 },
            B: { correct: 0, wrong: 0 },
            C: { correct: 0, wrong: 0 }
        };
        let gameMode = 'en-cn'; // é»˜è®¤è‹±è¯‘ä¸­æ¨¡å¼
        let difficulty = 'normal'; // é»˜è®¤æ™®é€šéš¾åº¦
        let soundEnabled = true; // é»˜è®¤å¼€å¯éŸ³æ•ˆ
        let groupsCount = 2; // é»˜è®¤2ç»„
        let gameHistory = JSON.parse(localStorage.getItem('vocabularyGameHistory')) || [];
        let optionsCount = 4;
        let usedWords = { A: [], B: [], C: [] }; // è®°å½•æ¯ä¸ªç»„å·²ç»ä½¿ç”¨è¿‡çš„å•è¯
        let wordStatus = {}; // è®°å½•æ¯ä¸ªå•è¯çš„å›ç­”æƒ…å†µ
        let currentQuestionIndex = { A: -1, B: -1, C: -1 }; // è®°å½•æ¯ä¸ªç»„å½“å‰é—®é¢˜çš„ç´¢å¼•

        // åˆå§‹åŒ–è®¾ç½®
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('gameTime').addEventListener('change', updateGameTime);
        document.getElementById('optionsCount').addEventListener('change', updateOptionsCount);
        document.getElementById('saveBtn').addEventListener('click', saveResults);
        document.getElementById('difficultyBtn').addEventListener('click', toggleDifficulty);
        document.getElementById('soundToggle').addEventListener('click', toggleSound);
        document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
        document.getElementById('groupsSelector').addEventListener('click', toggleGroupsCount);
        document.getElementById('reviewBtn').addEventListener('click', startReview); // æ–°å¢å¤ä¹ æŒ‰é’®äº‹ä»¶

        // æ¨¡å¼é€‰æ‹©
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                gameMode = this.dataset.mode;
            });
        });

        function updateGameTime() {
            const newTime = parseInt(document.getElementById('gameTime').value);
            if (!isNaN(newTime) && newTime >= 10 && newTime <= 600) {
                timeLeft = newTime;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `è®¡æ—¶ï¼š${timeLeft}`;
                }
            }
        }

        function updateOptionsCount() {
            optionsCount = parseInt(document.getElementById('optionsCount').value);
        }

        function toggleDifficulty() {
            const difficulties = ['easy', 'normal', 'hard'];
            const currentIndex = difficulties.indexOf(difficulty);
            const nextIndex = (currentIndex + 1) % difficulties.length;
            difficulty = difficulties[nextIndex];

            const btn = document.getElementById('difficultyBtn');
            switch (difficulty) {
                case 'easy':
                    btn.textContent = 'éš¾åº¦: ç®€å•';
                    btn.style.background = '#00b894';
                    break;
                case 'normal':
                    btn.textContent = 'éš¾åº¦: æ™®é€š';
                    btn.style.background = '#0984e3';
                    break;
                case 'hard':
                    btn.textContent = 'éš¾åº¦: å›°éš¾';
                    btn.style.background = '#d63031';
                    break;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            if (soundEnabled) {
                btn.textContent = 'éŸ³æ•ˆ: å¼€';
                btn.classList.remove('off');
            } else {
                btn.textContent = 'éŸ³æ•ˆ: å…³';
                btn.classList.add('off');
            }
        }

        function toggleGroupsCount() {
            groupsCount = groupsCount % 3 + 1; // å¾ªç¯1-3
            const btn = document.getElementById('groupsSelector');
            btn.textContent = `åˆ†ç»„: ${groupsCount}ç»„`;

            // æ˜¾ç¤º/éšè—åˆ†ç»„
            document.getElementById('groupA').style.display = groupsCount >= 1 ? 'block' : 'none';
            document.getElementById('groupB').style.display = groupsCount >= 2 ? 'block' : 'none';
            document.getElementById('groupC').style.display = groupsCount >= 3 ? 'block' : 'none';

            // é‡ç½®æ¯ä¸ªåˆ†ç»„çš„çŠ¶æ€
            if (groupsCount < 3) {
                usedWords.C = [];
                results.C = { correct: 0, wrong: 0 };
                const remainingC = document.getElementById('remainingC');
                if (remainingC) {
                    remainingC.textContent = wordsData.length;
                }
                const resultC = document.getElementById('resultC');
                if (resultC) {
                    resultC.innerHTML = '';
                }
            }
            if (groupsCount < 2) {
                usedWords.B = [];
                results.B = { correct: 0, wrong: 0 };
                const remainingB = document.getElementById('remainingB');
                if (remainingB) {
                    remainingB.textContent = wordsData.length;
                }
                const resultB = document.getElementById('resultB');
                if (resultB) {
                    resultB.innerHTML = '';
                }
            }

            // è°ƒæ•´æŒ‘æˆ˜å®¹å™¨å¸ƒå±€
            const gameContainer = document.getElementById('gameContainer');
            if (groupsCount === 1) {
                gameContainer.style.justifyContent = 'center';
                const groupA = document.getElementById('groupA');
                if (groupA) {
                    groupA.style.width = '70%';
                }
            } else {
                gameContainer.style.justifyContent = 'space-around';
                const groupA = document.getElementById('groupA');
                if (groupA) {
                    groupA.style.width = '45%';
                }
                const groupB = document.getElementById('groupB');
                if (groupB) {
                    groupB.style.width = '45%';
                }
                const groupC = document.getElementById('groupC');
                if (groupC) {
                    groupC.style.width = '45%';
                }
            }
        }

        function downloadTemplate() {
            // åˆ›å»ºç¤ºä¾‹æ•°æ®
            const templateData = [
                { è‹±æ–‡: "apple", ä¸­æ–‡: "n. è‹¹æœ" },
                { è‹±æ–‡: "banana", ä¸­æ–‡: "n. é¦™è•‰" },
                { è‹±æ–‡: "orange", ä¸­æ–‡: "æ©™å­" },
                { è‹±æ–‡: "grape", ä¸­æ–‡: "è‘¡è„" },
                { è‹±æ–‡: "watermelon", ä¸­æ–‡: "è¥¿ç“œ" }
            ];

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(templateData);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è¦è€ƒæŸ¥çš„å•è¯è¡¨");

            // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
            XLSX.writeFile(wb, "å•è¯è¡¨æ¨¡æ¿.xlsx");
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    wordsData = XLSX.utils.sheet_to_json(worksheet);
                    alert(`æˆåŠŸåŠ è½½ ${wordsData.length} ä¸ªå•è¯`);
                    updateRemainingWords();
                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æœ‰æ•ˆçš„Excelæ–‡ä»¶');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function startGame() {
            if (!wordsData.length) return alert('è¯·å…ˆä¸Šä¼ å•è¯æ–‡ä»¶');

            // é‡ç½®æŒ‘æˆ˜çŠ¶æ€
            timeLeft = parseInt(document.getElementById('gameTime').value) || 30;
            results = {
                A: { correct: 0, wrong: 0 },
                B: { correct: 0, wrong: 0 },
                C: { correct: 0, wrong: 0 }
            };
            usedWords = { A: [], B: [], C: [] }; // é‡ç½®å·²ä½¿ç”¨å•è¯åˆ—è¡¨
            wordStatus = {}; // é‡ç½®å•è¯å›ç­”çŠ¶æ€
            currentQuestionIndex = { A: -1, B: -1, C: -1 }; // é‡ç½®é—®é¢˜ç´¢å¼•

            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.style.display = 'inline-block';
                timerElement.textContent = `è®¡æ—¶ï¼š${timeLeft}`;
            }

            // æ ¹æ®éš¾åº¦è®¾ç½®è®¡æ—¶å™¨é€Ÿåº¦
            let timerSpeed = 1000; // é»˜è®¤1ç§’
            if (difficulty === 'easy') timerSpeed = 1500; // ç®€å•æ¨¡å¼1.5ç§’
            if (difficulty === 'hard') timerSpeed = 700; // å›°éš¾æ¨¡å¼0.7ç§’

            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (timer) clearInterval(timer);

            timer = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `è®¡æ—¶ï¼š${timeLeft}`;
                }
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showResults();
                }
            }, timerSpeed);

            // æ ¹æ®é€‰æ‹©çš„åˆ†ç»„æ•°é‡ç”Ÿæˆé—®é¢˜
            if (groupsCount >= 1) generateNewQuestion('A');
            if (groupsCount >= 2) generateNewQuestion('B');
            if (groupsCount >= 3) generateNewQuestion('C');
        }

        function setupQuestion(group, word) {
            const wordBox = document.getElementById(`word${group}`);
            const bubbles = document.getElementById(`bubbles${group}`);

            let question, correctAnswer;
            const count = parseInt(document.getElementById('optionsCount').value) || 4;

            switch (gameMode) {
                case 'en-cn': // è‹±è¯‘ä¸­
                    question = word.è‹±æ–‡.toLowerCase();
                    correctAnswer = word.ä¸­æ–‡;
                    if (wordBox) {
                        wordBox.textContent = question;
                    }
                    generateOptions(group, correctAnswer, 'ä¸­æ–‡', count);
                    break;

                case 'cn-en': // ä¸­è¯‘è‹±
                    question = word.ä¸­æ–‡;
                    correctAnswer = word.è‹±æ–‡.toLowerCase();
                    if (wordBox) {
                        wordBox.textContent = question;
                    }
                    generateOptions(group, correctAnswer, 'è‹±æ–‡', count);
                    break;

                case 'spelling': // æ‹¼å†™æµ‹è¯•
                    question = word.ä¸­æ–‡;
                    correctAnswer = word.è‹±æ–‡.toLowerCase();
                    if (wordBox) {
                        wordBox.textContent = `æ‹¼å†™: ${question}`;
                    }
                    generateOptions(group, correctAnswer, 'è‹±æ–‡', count);
                    break;
            }
        }

        function generateNewQuestion(group) {
            const availableWords = wordsData.filter(word => !usedWords[group].includes(word));
            if (!availableWords.length) {
                alert(`è¯¥ç»„å·²æ— å‰©ä½™å•è¯`);
                const nextBtn = document.querySelector(`#group${group} .next-btn`);
                if (nextBtn) {
                    nextBtn.disabled = true;
                }
                return;
            }

            const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            currentWords[group] = randomWord;
            usedWords[group].push(randomWord); // æ ‡è®°è¯¥å•è¯å·²ä½¿ç”¨
            currentQuestionIndex[group] = usedWords[group].length - 1;

            setupQuestion(group, randomWord);
            updateRemainingWords();
            const nextBtn = document.querySelector(`#group${group} .next-btn`);
            if (nextBtn) {
                nextBtn.disabled = false;
            }
        }

        function generateOptions(group, correctAnswer, field, count) {
            const options = [correctAnswer];

            if (gameMode === 'spelling') {
                // ç”Ÿæˆå½¢è¿‘è¯æˆ–æ‹¼å†™æ˜“æ··è¯ä½œä¸ºå¹²æ‰°é¡¹
                while (options.length < count) {
                    const similarWord = generateSimilarWord(correctAnswer);
                    if (!options.includes(similarWord) && similarWord!== correctAnswer) {
                        options.push(similarWord);
                    }
                }
            } else {
                // ç”Ÿæˆå¹²æ‰°é¡¹
                while (options.length < count) {
                    const randomWord = wordsData[Math.floor(Math.random() * wordsData.length)];
                    const randomOption = randomWord[field].toLowerCase();

                    // ç¡®ä¿å¹²æ‰°é¡¹ä¸é‡å¤ä¸”ä¸ä¸æ­£ç¡®ç­”æ¡ˆç›¸åŒ
                    if (!options.includes(randomOption) && randomOption!== correctAnswer) {
                        options.push(randomOption);
                    }
                }
            }

            // éšæœºæ’åºé€‰é¡¹
            options.sort(() => Math.random() - 0.5);

            // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆæ°”æ³¡é€‰é¡¹
            const bubbles = document.getElementById(`bubbles${group}`);
            if (bubbles) {
                bubbles.innerHTML = '';
            }

            options.forEach(option => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = option;
                bubble.onclick = (e) => checkAnswer(group, option, e);
                if (bubbles) {
                    bubbles.appendChild(bubble);
                }
            });
        }

        function generateSimilarWord(word) {
            const index = Math.floor(Math.random() * word.length);
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            const randomChar = alphabet[Math.floor(Math.random() * alphabet.length)];
            return word.slice(0, index) + randomChar + word.slice(index + 1);
        }

        function checkAnswer(group, selected, e) {
            if (!currentWords[group]) return;

            let isCorrect = false;
            const correctSound = document.querySelector('.correct-sound');
            const wrongSound = document.querySelector('.wrong-sound');

            // æ ¹æ®æŒ‘æˆ˜æ¨¡å¼åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
            switch (gameMode) {
                case 'en-cn':
                    isCorrect = selected === currentWords[group].ä¸­æ–‡;
                    break;
                case 'cn-en':
                case 'spelling':
                    isCorrect = selected.toLowerCase() === currentWords[group].è‹±æ–‡.toLowerCase();
                    break;
            }

            if (isCorrect) {
                results[group].correct++;
                wordStatus[currentWords[group].è‹±æ–‡] = true; // æ ‡è®°ä¸ºå›ç­”æ­£ç¡®
                if (soundEnabled) {
                    if (correctSound) {
                        correctSound.currentTime = 0;
                        correctSound.play();
                    }
                }
                generateNewQuestion(group);
                updateRemainingWords();
            } else {
                results[group].wrong++;
                wordStatus[currentWords[group].è‹±æ–‡] = false; // æ ‡è®°ä¸ºå›ç­”é”™è¯¯
                if (soundEnabled) {
                    if (wrongSound) {
                        wrongSound.currentTime = 0;
                        wrongSound.play();
                    }
                }
                if (e.target) {
                    e.target.style.background = '#dfe6e9';
                    e.target.style.borderColor = '#b2bec3';
                    e.target.style.animation = 'none';
                }

                // å›°éš¾æ¨¡å¼ä¸‹ç­”é”™ä¼šå‡å°‘æ—¶é—´
                if (difficulty === 'hard') {
                    timeLeft = Math.max(1, timeLeft - 2);
                    const timerElement = document.getElementById('timer');
                    if (timerElement) {
                        timerElement.textContent = `è®¡æ—¶ï¼š${timeLeft}`;
                    }
                }
            }
        }

        function showResults() {
            if (groupsCount >= 1) {
                const resultA = document.getElementById('resultA');
                if (resultA) {
                    resultA.innerHTML = `
                        ğŸ‰ æ­£ç¡®ï¼š${results.A.correct} &nbsp;&nbsp; âŒ é”™è¯¯ï¼š${results.A.wrong}
                    `;
                }
            }
            if (groupsCount >= 2) {
                const resultB = document.getElementById('resultB');
                if (resultB) {
                    resultB.innerHTML = `
                        ğŸ‰ æ­£ç¡®ï¼š${results.B.correct} &nbsp;&nbsp; âŒ é”™è¯¯ï¼š${results.B.wrong}
                    `;
                }
            }
            if (groupsCount >= 3) {
                const resultC = document.getElementById('resultC');
                if (resultC) {
                    resultC.innerHTML = `
                        ğŸ‰ æ­£ç¡®ï¼š${results.C.correct} &nbsp;&nbsp; âŒ é”™è¯¯ï¼š${results.C.wrong}
                    `;
                }
            }

            // ä¿å­˜ç»“æœåˆ°å†å²è®°å½•
            saveToHistory();
        }

        function saveToHistory() {
            const timestamp = new Date().toISOString();
            const totalA = results.A.correct + results.A.wrong;
            const totalB = results.B.correct + results.B.wrong;
            const totalC = results.C.correct + results.C.wrong;
            const accuracyA = totalA > 0 ? Math.round((results.A.correct / totalA) * 100) : 0;
            const accuracyB = totalB > 0 ? Math.round((results.B.correct / totalB) * 100) : 0;
            const accuracyC = totalC > 0 ? Math.round((results.C.correct / totalC) * 100) : 0;

            gameHistory.push({
                timestamp,
                mode: gameMode,
                difficulty,
                timeLimit: parseInt(document.getElementById('gameTime').value) || 30,
                groupsCount,
                groupA: { ...results.A, total: totalA, accuracy: accuracyA },
                groupB: { ...results.B, total: totalB, accuracy: accuracyB },
                groupC: { ...results.C, total: totalC, accuracy: accuracyC },
                wordStatus
            });

            // åªä¿ç•™æœ€è¿‘çš„50æ¡è®°å½•
            if (gameHistory.length > 50) {
                gameHistory = gameHistory.slice(-50);
            }

            localStorage.setItem('vocabularyGameHistory', JSON.stringify(gameHistory));
        }

        function saveResults() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ä¿å­˜çš„æˆç»©
            let hasResults = false;
            for (let i = 1; i <= groupsCount; i++) {
                const group = String.fromCharCode(64 + i);
                if (results[group].correct > 0 || results[group].wrong > 0) {
                    hasResults = true;
                    break;
                }
            }

            if (!hasResults) return alert('æ²¡æœ‰å¯ä¿å­˜çš„æˆç»©è®°å½•');

            // ç»Ÿä¸€ä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦
            const separator = ',';

            // åˆ›å»ºCSVå†…å®¹ï¼Œè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
            let csvContent = "\uFEFF"; // æ·»åŠ BOMå¤´è§£å†³ä¸­æ–‡ä¹±ç 
            csvContent += `æ•°æ®${separator}ç»„A${separator}ç»„B${separator}ç»„C\n`;
            csvContent += `æ­£ç¡®${separator}${results.A.correct}${separator}${results.B.correct}${separator}${results.C.correct}\n`;
            csvContent += `é”™è¯¯${separator}${results.A.wrong}${separator}${results.B.wrong}${separator}${results.C.wrong}\n`;

            const totalA = results.A.correct + results.A.wrong;
            const totalB = results.B.correct + results.B.wrong;
            const totalC = results.C.correct + results.C.wrong;
            const accuracyA = totalA > 0 ? Math.round((results.A.correct / totalA) * 100) : 0;
            const accuracyB = totalB > 0 ? Math.round((results.B.correct / totalB) * 100) : 0;
            const accuracyC = totalC > 0 ? Math.round((results.C.correct / totalC) * 100) : 0;

            csvContent += `æ€»è®¡${separator}${totalA}${separator}${totalB}${separator}${totalC}\n`;
            csvContent += `æ­£ç¡®ç‡${separator}${accuracyA}%${separator}${accuracyB}%${separator}${accuracyC}%\n`;
            csvContent += `æŒ‘æˆ˜æ¨¡å¼${separator}${getModeName(gameMode)}\n`;
            csvContent += `éš¾åº¦${separator}${getDifficultyName(difficulty)}\n`;
            csvContent += `åˆ†ç»„æ•°é‡${separator}${groupsCount}\n`;
            csvContent += `æ—¶é—´é™åˆ¶${separator}${parseInt(document.getElementById('gameTime').value) || 30}`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download!== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'æˆç»©è®°å½•.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function getModeName(mode) {
            switch (mode) {
                case 'en-cn':
                    return 'è‹±â†’ä¸­';
                case 'cn-en':
                    return 'ä¸­â†’è‹±';
                case 'spelling':
                    return 'æ‹¼å†™æµ‹è¯•';
                default:
                    return 'æœªçŸ¥æ¨¡å¼';
            }
        }

        function getDifficultyName(difficulty) {
            switch (difficulty) {
                case 'easy':
                    return 'ç®€å•';
                case 'normal':
                    return 'æ™®é€š';
                case 'hard':
                    return 'å›°éš¾';
                default:
                    return 'æœªçŸ¥éš¾åº¦';
            }
        }

        function updateRemainingWords() {
            if (groupsCount >= 1) {
                const remainingA = document.getElementById('remainingA');
                if (remainingA) {
                    remainingA.textContent = wordsData.length - usedWords.A.length;
                }
            }
            if (groupsCount >= 2) {
                const remainingB = document.getElementById('remainingB');
                if (remainingB) {
                    remainingB.textContent = wordsData.length - usedWords.B.length;
                }
            }
            if (groupsCount >= 3) {
                const remainingC = document.getElementById('remainingC');
                if (remainingC) {
                    remainingC.textContent = wordsData.length - usedWords.C.length;
                }
            }
        }

        function prevQuestion(group) {
            if (currentQuestionIndex[group] > 0) {
                currentQuestionIndex[group]--;
                const prevWord = usedWords[group][currentQuestionIndex[group]];
                currentWords[group] = prevWord;
                setupQuestion(group, prevWord);
                const prevBtn = document.querySelector(`#group${group} .prev-btn`);
                if (prevBtn) {
                    prevBtn.disabled = false;
                }
                const nextBtn = document.querySelector(`#group${group} .next-btn`);
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            } else {
                alert('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜äº†');
                const prevBtn = document.querySelector(`#group${group} .prev-btn`);
                if (prevBtn) {
                    prevBtn.disabled = true;
                }
            }
        }

        function nextQuestion(group) {
            generateNewQuestion(group);
        }

        function resetGame() {
            // é‡ç½®æŒ‘æˆ˜çŠ¶æ€
            timeLeft = parseInt(document.getElementById('gameTime').value) || 30;
            results = {
                A: { correct: 0, wrong: 0 },
                B: { correct: 0, wrong: 0 },
                C: { correct: 0, wrong: 0 }
            };
            usedWords = { A: [], B: [], C: [] }; // é‡ç½®å·²ä½¿ç”¨å•è¯åˆ—è¡¨
            wordStatus = {}; // é‡ç½®å•è¯å›ç­”çŠ¶æ€
            currentQuestionIndex = { A: -1, B: -1, C: -1 }; // é‡ç½®é—®é¢˜ç´¢å¼•

            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = `è®¡æ—¶ï¼š${timeLeft}`;
            }

            const resultA = document.getElementById('resultA');
            if (resultA) {
                resultA.innerHTML = '';
            }
            const resultB = document.getElementById('resultB');
            if (resultB) {
                resultB.innerHTML = '';
            }
            const resultC = document.getElementById('resultC');
            if (resultC) {
                resultC.innerHTML = '';
            }

            updateRemainingWords();
        }

        function startReview() {
            if (!wordsData.length) return alert('è¯·å…ˆä¸Šä¼ å•è¯æ–‡ä»¶');

            // åˆ›å»ºæ–°çª—å£
            const reviewWindow = window.open('', '_blank');
            if (reviewWindow) {
                // ç”Ÿæˆå¤ä¹ é¡µé¢å†…å®¹
                let reviewContent = '<html><head><title>å•è¯å¤ä¹ </title><style>';
                reviewContent += '.correct { background-color: rgba(144, 238, 144, 0.5); }';
                reviewContent += '.wrong { background-color: rgba(255, 192, 203, 0.5); }';
                reviewContent += '</style></head><body>';

                wordsData.forEach(word => {
                    const status = wordStatus[word.è‹±æ–‡];
                    const className = status === true? 'correct' : 'wrong';
                    reviewContent += `<p class="${className}">${word.è‹±æ–‡} - ${word.ä¸­æ–‡}</p>`;
                });

                reviewContent += '</body></html>';

                // å°†å†…å®¹å†™å…¥æ–°çª—å£
                reviewWindow.document.write(reviewContent);
                reviewWindow.document.close();
            }
        }

function playSound(word) {
    const synth = window.speechSynthesis;
    let textToSpeak = word;

    if (gameMode === 'cn-en' || gameMode === 'spelling') {
        // æå–ä¸­æ–‡å†…å®¹ï¼Œå»é™¤è¯æ€§ç­‰éä¸­æ–‡å†…å®¹
        textToSpeak = textToSpeak.replace(/[a-zA-Z. ]+/g, '');

        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        // è®¾ç½®ä¸­æ–‡è¯­è¨€
        utterance.lang = 'zh-CN';

        // å°è¯•è®¾ç½®é«˜è´¨é‡çš„è¯­éŸ³å¼•æ“ï¼ˆä¸åŒæµè§ˆå™¨æ”¯æŒçš„è¯­éŸ³å¼•æ“å¯èƒ½ä¸åŒï¼‰
        const voices = synth.getVoices();
        for (let i = 0; i < voices.length; i++) {
            if (voices[i].lang === 'zh-CN') {
                // ä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ç‰¹å®šçš„è¯­éŸ³å¼•æ“
                utterance.voice = voices[i];
                break;
            }
        }

        // è®¾ç½®éŸ³é‡ï¼ˆèŒƒå›´ä» 0 åˆ° 1ï¼‰
        utterance.volume = 1;

        synth.speak(utterance);
    } else if (gameMode === 'en-cn' || gameMode === 'spelling') {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        synth.speak(utterance);
    }
}

    </script>
</body>

</html>
