<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Vocabulary Challenge</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #f9f5ff;
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

       .header {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #e84393;
            font-size: 1.6em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

       .main-title {
            text-align: left;
            color: #6c5ce7;
            font-size: 2.8em;
            margin: 20px 0 20px;
            letter-spacing: 2px;
            display: inline-block;
        }

        #timer {
            position: relative;
            font-size: 2.5em;
            color: #e84393;
            background: linear-gradient(45deg, #e1f5fe, #f3e5f5);
            /* 浅色调彩色背景 */
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: fit-content;
            margin: 0 0 0 20px;
            display: inline-block;
            vertical-align: middle;
        }

       .game-container {
            display: flex;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            z-index: 1;
            position: relative;
        }

       .group {
            flex: 1;
            background: #ffffff;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            position: relative;
        }

       .group-title {
            text-align: center;
            color: #00b894;
            font-size: 1.8em;
            margin: 0 0 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

       .word-box-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

       .word-box {
            background: #ffe0f7;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.6em;
            text-align: center;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.05);
            border: 2px dashed #ff9ff3;
            cursor: pointer; /* 添加光标样式 */
            width: 70%; /* 调整单词框宽度 */
        }

       .prev-btn,
       .next-btn {
            padding: 18px 8px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px; /* 调整按钮间距 */
        }

       .prev-btn:hover,
       .next-btn:hover {
            background: #574b90;
        }

       .bubbles-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

       .bubble {
            min-width: 120px;
            height: 120px;
            background: #81ecec;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            animation: float 2.5s ease-in-out infinite;
            font-size: 1.3em;
            color: #000000;
            border: 2px solid #00cec9;
            text-align: center;
            word-break: break-word;
        }

        @keyframes float {
            0%,
            100% {
                transform: translateY(0) rotate(-2deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

       .start-btn {
            padding: 10px 20px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            display: inline-block;
        }

       .reset-btn {
            padding: 10px 20px;
            background: #e84393;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            display: inline-block;
        }

        #fileInput {
            position: fixed;
            bottom: 25px;
            left: 25px;
            padding: 6px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

       .download-template {
            position: fixed;
            bottom: 27px;
            left: 235px; /* 调整到打开文件框右侧 */
            padding: 8px 15px; /* 缩小按钮 */
            border-radius: 8px;
            background: #0984e3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em; /* 缩小字体 */
        }

       .review-btn {
            position: fixed;
            bottom: 160px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .result {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
            color: #e84393;
            font-weight: bold;
            padding: 10px;
            background: #fff1f8;
            border-radius: 10px;
        }

       .settings-panel {
            position: fixed;
            bottom: 260px;
            right: 25px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 0;
            width: 100px;
            /* 修改宽度为现有一半 */
        }

       .settings-row {
            margin-bottom: 10px;
        }

       .settings-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #6c5ce7;
            font-size: 0.9em;
        }

       .settings-row input,
       .settings-row select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.9em;
        }

       .mode-selector {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            /* 调整间距 */
        }

       .mode-btn {
            padding: 10px 20px;
            background: #fdcb6e;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 10px;
            /* 按钮之间的间距 */
        }

       .mode-btn.active {
            background: #6c5ce7;
            transform: scale(1.05);
        }

       .save-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #e84393;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .difficulty-btn {
            position: fixed;
            bottom: 70px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .progress-ring {
            position: fixed;
            top: 22%;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
        }

       .correct-sound,
       .wrong-sound {
            display: none;
        }

       .sound-toggle {
            position: fixed;
            bottom: 115px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #6c5ce7;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .sound-toggle.off {
            background: #b2bec3;
        }

       .groups-selector {
            position: fixed;
            bottom: 205px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #00cec9;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

       .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
           .game-container {
                flex-direction: column;
                max-width: 800px;
            }

           .group {
                margin-bottom: 20px;
            }

           .bubble {
                min-width: 100px;
                height: 100px;
                font-size: 1em;
            }

           .settings-panel {
                bottom: 25px;
                right: 180px;
                width: 90px;
                /* 修改响应式布局下的宽度 */
            }
        }
    </style>
</head>

<body>
    <!-- 添加超链接包裹文字，使用 target="_blank" 新窗口打开 -->
    <a href="http://2006b.ys168.com" target="_blank">
        <div class="header">by Evita & CreativeLearner v2.4</div>
    </a>
    <!-- 将图片包裹在 <a> 标签内 -->
    <a href="http://2006b.ys168.com" target="_blank">
        <img src="https://s3.bmp.ovh/imgs/2025/05/18/5748f0662563f7e7.png" width="182"
            height="110" style="position: relative;">
    </a>
    <div class="settings-panel">
        <div class="settings-row">
            <label for="gameTime">挑战时间(秒):</label>
            <input type="number" id="gameTime" value="60" min="10" max="600">
        </div>
        <div class="settings-row">
            <label for="optionsCount">选项数量:</label>
            <select id="optionsCount">
                <option value="2">2个选项</option>
                <option value="3">3个选项</option>
                <option value="4" selected>4个选项</option>
                <option value="5">5个选项</option>
                <option value="6">6个选项</option>
            </select>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx,.xls">
    <!-- 新增超链接 -->
    <a href="https://creativelearner.lanzouy.com/b0hd1d0af" target="_blank" style="position: fixed; bottom: 5px; left: 25px; font-family: 'Microsoft YaHei';">更多单词表下载>密码 clearn</a> 
    <button class="download-template" id="downloadTemplate">下载单词表模板</button>
    <button class="review-btn" id="reviewBtn">单词复习</button>
    <button class="groups-selector" id="groupsSelector">分组: 2组</button>
    <button class="difficulty-btn" id="difficultyBtn">难度: 普通</button>
    <button class="sound-toggle" id="soundToggle">音效: 开</button>
    <button class="save-btn" id="saveBtn">保存成绩</button>
    <!-- 新增的超链接 -->
    <a href="https://github.com/carfox163/cr" target="_blank" style="position: fixed; bottom: 5px; right: 15px; font-family: 'Microsoft YaHei';">github项目</a>
    <a href="https://creativelearners.netlify.app/" target="_blank" style="position: fixed; bottom: 5px; right: 105px; font-family: 'Microsoft YaHei';">在线版</a>

    <h1 class="main-title">Vocabulary Challenge</h1>
    <div id="timer">计时：60</div>
    <div class="mode-selector">
        <button class="mode-btn active" data-mode="en-cn">英→中</button>
        <button class="mode-btn" data-mode="cn-en">中→英</button>
        <button class="mode-btn" data-mode="spelling">拼写测试</button>
        <button class="start-btn" onclick="startGame()">开始</button>
        <button class="reset-btn" onclick="resetGame()">重置</button>
    </div>

    <div class="game-container" id="gameContainer">
        <div class="group" id="groupA">
            <h2 class="group-title">A组 剩余： <span id="remainingA">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('A')">←</button>
                <div class="word-box" id="wordA" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('A')">→</button>
            </div>
            <div class="bubbles-container" id="bubblesA"></div>
            <div class="result" id="resultA"></div>
        </div>
        <div class="group" id="groupB">
            <h2 class="group-title">B组 剩余：  <span id="remainingB">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('B')">←</button>
                <div class="word-box" id="wordB" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('B')">→</button>
            </div>
            <div class="bubbles-container" id="bubblesB"></div>
            <div class="result" id="resultB"></div>
        </div>
        <div class="group" id="groupC" style="display: none;">
            <h2 class="group-title">C组 剩余：  <span id="remainingC">0</span></h2>
            <div class="word-box-container">
                <button class="prev-btn" onclick="prevQuestion('C')">←</button>
                <div class="word-box" id="wordC" onclick="playSound(this.textContent)"></div>
                <button class="next-btn" onclick="nextQuestion('C')">→</button>
            </div>
            <div class="bubbles-container" id="bubblesC"></div>
            <div class="result" id="resultC"></div>
        </div>
    </div>

    <!-- 音效元素 -->
    <audio class="correct-sound">
        <source src="https://cdn.pixabay.com/audio/2021/08/04/audio_c201b79c03.mp3" type="audio/mpeg">
        您的浏览器不支持音频播放。
    </audio>
    <audio class="wrong-sound">
        <source src="https://cdn.pixabay.com/audio/2022/03/10/audio_6b59debae7.mp3" type="audio/mpeg">
        您的浏览器不支持音频播放。
    </audio>

    <script>
        let wordsData = [];
        let currentWords = { A: null, B: null, C: null };
        let timer;
        let timeLeft = 30;
        let results = {
            A: { correct: 0, wrong: 0 },
            B: { correct: 0, wrong: 0 },
            C: { correct: 0, wrong: 0 }
        };
        let gameMode = 'en-cn'; // 默认英译中模式
        let difficulty = 'normal'; // 默认普通难度
        let soundEnabled = true; // 默认开启音效
        let groupsCount = 2; // 默认2组
        let gameHistory = JSON.parse(localStorage.getItem('vocabularyGameHistory')) || [];
        let optionsCount = 4;
        let usedWords = { A: [], B: [], C: [] }; // 记录每个组已经使用过的单词
        let wordStatus = {}; // 记录每个单词的回答情况
        let currentQuestionIndex = { A: -1, B: -1, C: -1 }; // 记录每个组当前问题的索引

        // 初始化设置
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('gameTime').addEventListener('change', updateGameTime);
        document.getElementById('optionsCount').addEventListener('change', updateOptionsCount);
        document.getElementById('saveBtn').addEventListener('click', saveResults);
        document.getElementById('difficultyBtn').addEventListener('click', toggleDifficulty);
        document.getElementById('soundToggle').addEventListener('click', toggleSound);
        document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
        document.getElementById('groupsSelector').addEventListener('click', toggleGroupsCount);
        document.getElementById('reviewBtn').addEventListener('click', startReview); // 新增复习按钮事件

        // 模式选择
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                gameMode = this.dataset.mode;
            });
        });

        function updateGameTime() {
            const newTime = parseInt(document.getElementById('gameTime').value);
            if (!isNaN(newTime) && newTime >= 10 && newTime <= 600) {
                timeLeft = newTime;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `计时：${timeLeft}`;
                }
            }
        }

        function updateOptionsCount() {
            optionsCount = parseInt(document.getElementById('optionsCount').value);
        }

        function toggleDifficulty() {
            const difficulties = ['easy', 'normal', 'hard'];
            const currentIndex = difficulties.indexOf(difficulty);
            const nextIndex = (currentIndex + 1) % difficulties.length;
            difficulty = difficulties[nextIndex];

            const btn = document.getElementById('difficultyBtn');
            switch (difficulty) {
                case 'easy':
                    btn.textContent = '难度: 简单';
                    btn.style.background = '#00b894';
                    break;
                case 'normal':
                    btn.textContent = '难度: 普通';
                    btn.style.background = '#0984e3';
                    break;
                case 'hard':
                    btn.textContent = '难度: 困难';
                    btn.style.background = '#d63031';
                    break;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            if (soundEnabled) {
                btn.textContent = '音效: 开';
                btn.classList.remove('off');
            } else {
                btn.textContent = '音效: 关';
                btn.classList.add('off');
            }
        }

        function toggleGroupsCount() {
            groupsCount = groupsCount % 3 + 1; // 循环1-3
            const btn = document.getElementById('groupsSelector');
            btn.textContent = `分组: ${groupsCount}组`;

            // 显示/隐藏分组
            document.getElementById('groupA').style.display = groupsCount >= 1 ? 'block' : 'none';
            document.getElementById('groupB').style.display = groupsCount >= 2 ? 'block' : 'none';
            document.getElementById('groupC').style.display = groupsCount >= 3 ? 'block' : 'none';

            // 重置每个分组的状态
            if (groupsCount < 3) {
                usedWords.C = [];
                results.C = { correct: 0, wrong: 0 };
                const remainingC = document.getElementById('remainingC');
                if (remainingC) {
                    remainingC.textContent = wordsData.length;
                }
                const resultC = document.getElementById('resultC');
                if (resultC) {
                    resultC.innerHTML = '';
                }
            }
            if (groupsCount < 2) {
                usedWords.B = [];
                results.B = { correct: 0, wrong: 0 };
                const remainingB = document.getElementById('remainingB');
                if (remainingB) {
                    remainingB.textContent = wordsData.length;
                }
                const resultB = document.getElementById('resultB');
                if (resultB) {
                    resultB.innerHTML = '';
                }
            }

            // 调整挑战容器布局
            const gameContainer = document.getElementById('gameContainer');
            if (groupsCount === 1) {
                gameContainer.style.justifyContent = 'center';
                const groupA = document.getElementById('groupA');
                if (groupA) {
                    groupA.style.width = '70%';
                }
            } else {
                gameContainer.style.justifyContent = 'space-around';
                const groupA = document.getElementById('groupA');
                if (groupA) {
                    groupA.style.width = '45%';
                }
                const groupB = document.getElementById('groupB');
                if (groupB) {
                    groupB.style.width = '45%';
                }
                const groupC = document.getElementById('groupC');
                if (groupC) {
                    groupC.style.width = '45%';
                }
            }
        }

        function downloadTemplate() {
            // 创建示例数据
            const templateData = [
                { 英文: "apple", 中文: "n. 苹果" },
                { 英文: "banana", 中文: "n. 香蕉" },
                { 英文: "orange", 中文: "橙子" },
                { 英文: "grape", 中文: "葡萄" },
                { 英文: "watermelon", 中文: "西瓜" }
            ];

            // 创建工作表
            const ws = XLSX.utils.json_to_sheet(templateData);

            // 创建工作簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "要考查的单词表");

            // 生成Excel文件并下载
            XLSX.writeFile(wb, "单词表模板.xlsx");
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    wordsData = XLSX.utils.sheet_to_json(worksheet);
                    alert(`成功加载 ${wordsData.length} 个单词`);
                    updateRemainingWords();
                } catch (error) {
                    alert('文件读取失败，请确保上传的是有效的Excel文件');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function startGame() {
            if (!wordsData.length) return alert('请先上传单词文件');

            // 重置挑战状态
            timeLeft = parseInt(document.getElementById('gameTime').value) || 30;
            results = {
                A: { correct: 0, wrong: 0 },
                B: { correct: 0, wrong: 0 },
                C: { correct: 0, wrong: 0 }
            };
            usedWords = { A: [], B: [], C: [] }; // 重置已使用单词列表
            wordStatus = {}; // 重置单词回答状态
            currentQuestionIndex = { A: -1, B: -1, C: -1 }; // 重置问题索引

            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.style.display = 'inline-block';
                timerElement.textContent = `计时：${timeLeft}`;
            }

            // 根据难度设置计时器速度
            let timerSpeed = 1000; // 默认1秒
            if (difficulty === 'easy') timerSpeed = 1500; // 简单模式1.5秒
            if (difficulty === 'hard') timerSpeed = 700; // 困难模式0.7秒

            // 清除之前的计时器
            if (timer) clearInterval(timer);

            timer = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `计时：${timeLeft}`;
                }
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showResults();
                }
            }, timerSpeed);

            // 根据选择的分组数量生成问题
            if (groupsCount >= 1) generateNewQuestion('A');
            if (groupsCount >= 2) generateNewQuestion('B');
            if (groupsCount >= 3) generateNewQuestion('C');
        }

        function setupQuestion(group, word) {
            const wordBox = document.getElementById(`word${group}`);
            const bubbles = document.getElementById(`bubbles${group}`);

            let question, correctAnswer;
            const count = parseInt(document.getElementById('optionsCount').value) || 4;

            switch (gameMode) {
                case 'en-cn': // 英译中
                    question = word.英文.toLowerCase();
                    correctAnswer = word.中文;
                    if (wordBox) {
                        wordBox.textContent = question;
                    }
                    generateOptions(group, correctAnswer, '中文', count);
                    break;

                case 'cn-en': // 中译英
                    question = word.中文;
                    correctAnswer = word.英文.toLowerCase();
                    if (wordBox) {
                        wordBox.textContent = question;
                    }
                    generateOptions(group, correctAnswer, '英文', count);
                    break;

                case 'spelling': // 拼写测试
                    question = word.中文;
                    correctAnswer = word.英文.toLowerCase();
                    if (wordBox) {
                        wordBox.textContent = `拼写: ${question}`;
                    }
                    generateOptions(group, correctAnswer, '英文', count);
                    break;
            }
        }

        function generateNewQuestion(group) {
            const availableWords = wordsData.filter(word => !usedWords[group].includes(word));
            if (!availableWords.length) {
                alert(`该组已无剩余单词`);
                const nextBtn = document.querySelector(`#group${group} .next-btn`);
                if (nextBtn) {
                    nextBtn.disabled = true;
                }
                return;
            }

            const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            currentWords[group] = randomWord;
            usedWords[group].push(randomWord); // 标记该单词已使用
            currentQuestionIndex[group] = usedWords[group].length - 1;

            setupQuestion(group, randomWord);
            updateRemainingWords();
            const nextBtn = document.querySelector(`#group${group} .next-btn`);
            if (nextBtn) {
                nextBtn.disabled = false;
            }
        }

        function generateOptions(group, correctAnswer, field, count) {
            const options = [correctAnswer];

            if (gameMode === 'spelling') {
                // 生成形近词或拼写易混词作为干扰项
                while (options.length < count) {
                    const similarWord = generateSimilarWord(correctAnswer);
                    if (!options.includes(similarWord) && similarWord!== correctAnswer) {
                        options.push(similarWord);
                    }
                }
            } else {
                // 生成干扰项
                while (options.length < count) {
                    const randomWord = wordsData[Math.floor(Math.random() * wordsData.length)];
                    const randomOption = randomWord[field].toLowerCase();

                    // 确保干扰项不重复且不与正确答案相同
                    if (!options.includes(randomOption) && randomOption!== correctAnswer) {
                        options.push(randomOption);
                    }
                }
            }

            // 随机排序选项
            options.sort(() => Math.random() - 0.5);

            // 清空并重新生成气泡选项
            const bubbles = document.getElementById(`bubbles${group}`);
            if (bubbles) {
                bubbles.innerHTML = '';
            }

            options.forEach(option => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = option;
                bubble.onclick = (e) => checkAnswer(group, option, e);
                if (bubbles) {
                    bubbles.appendChild(bubble);
                }
            });
        }

        function generateSimilarWord(word) {
            const index = Math.floor(Math.random() * word.length);
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            const randomChar = alphabet[Math.floor(Math.random() * alphabet.length)];
            return word.slice(0, index) + randomChar + word.slice(index + 1);
        }

        function checkAnswer(group, selected, e) {
            if (!currentWords[group]) return;

            let isCorrect = false;
            const correctSound = document.querySelector('.correct-sound');
            const wrongSound = document.querySelector('.wrong-sound');

            // 根据挑战模式判断答案是否正确
            switch (gameMode) {
                case 'en-cn':
                    isCorrect = selected === currentWords[group].中文;
                    break;
                case 'cn-en':
                case 'spelling':
                    isCorrect = selected.toLowerCase() === currentWords[group].英文.toLowerCase();
                    break;
            }

            if (isCorrect) {
                results[group].correct++;
                wordStatus[currentWords[group].英文] = true; // 标记为回答正确
                if (soundEnabled) {
                    if (correctSound) {
                        correctSound.currentTime = 0;
                        correctSound.play();
                    }
                }
                generateNewQuestion(group);
                updateRemainingWords();
            } else {
                results[group].wrong++;
                wordStatus[currentWords[group].英文] = false; // 标记为回答错误
                if (soundEnabled) {
                    if (wrongSound) {
                        wrongSound.currentTime = 0;
                        wrongSound.play();
                    }
                }
                if (e.target) {
                    e.target.style.background = '#dfe6e9';
                    e.target.style.borderColor = '#b2bec3';
                    e.target.style.animation = 'none';
                }

                // 困难模式下答错会减少时间
                if (difficulty === 'hard') {
                    timeLeft = Math.max(1, timeLeft - 2);
                    const timerElement = document.getElementById('timer');
                    if (timerElement) {
                        timerElement.textContent = `计时：${timeLeft}`;
                    }
                }
            }
        }

        function showResults() {
            if (groupsCount >= 1) {
                const resultA = document.getElementById('resultA');
                if (resultA) {
                    resultA.innerHTML = `
                        🎉 正确：${results.A.correct} &nbsp;&nbsp; ❌ 错误：${results.A.wrong}
                    `;
                }
            }
            if (groupsCount >= 2) {
                const resultB = document.getElementById('resultB');
                if (resultB) {
                    resultB.innerHTML = `
                        🎉 正确：${results.B.correct} &nbsp;&nbsp; ❌ 错误：${results.B.wrong}
                    `;
                }
            }
            if (groupsCount >= 3) {
                const resultC = document.getElementById('resultC');
                if (resultC) {
                    resultC.innerHTML = `
                        🎉 正确：${results.C.correct} &nbsp;&nbsp; ❌ 错误：${results.C.wrong}
                    `;
                }
            }

            // 保存结果到历史记录
            saveToHistory();
        }

        function saveToHistory() {
            const timestamp = new Date().toISOString();
            const totalA = results.A.correct + results.A.wrong;
            const totalB = results.B.correct + results.B.wrong;
            const totalC = results.C.correct + results.C.wrong;
            const accuracyA = totalA > 0 ? Math.round((results.A.correct / totalA) * 100) : 0;
            const accuracyB = totalB > 0 ? Math.round((results.B.correct / totalB) * 100) : 0;
            const accuracyC = totalC > 0 ? Math.round((results.C.correct / totalC) * 100) : 0;

            gameHistory.push({
                timestamp,
                mode: gameMode,
                difficulty,
                timeLimit: parseInt(document.getElementById('gameTime').value) || 30,
                groupsCount,
                groupA: { ...results.A, total: totalA, accuracy: accuracyA },
                groupB: { ...results.B, total: totalB, accuracy: accuracyB },
                groupC: { ...results.C, total: totalC, accuracy: accuracyC },
                wordStatus
            });

            // 只保留最近的50条记录
            if (gameHistory.length > 50) {
                gameHistory = gameHistory.slice(-50);
            }

            localStorage.setItem('vocabularyGameHistory', JSON.stringify(gameHistory));
        }

        function saveResults() {
            // 检查是否有可保存的成绩
            let hasResults = false;
            for (let i = 1; i <= groupsCount; i++) {
                const group = String.fromCharCode(64 + i);
                if (results[group].correct > 0 || results[group].wrong > 0) {
                    hasResults = true;
                    break;
                }
            }

            if (!hasResults) return alert('没有可保存的成绩记录');

            // 统一使用逗号作为分隔符
            const separator = ',';

            // 创建CSV内容，解决中文乱码问题
            let csvContent = "\uFEFF"; // 添加BOM头解决中文乱码
            csvContent += `数据${separator}组A${separator}组B${separator}组C\n`;
            csvContent += `正确${separator}${results.A.correct}${separator}${results.B.correct}${separator}${results.C.correct}\n`;
            csvContent += `错误${separator}${results.A.wrong}${separator}${results.B.wrong}${separator}${results.C.wrong}\n`;

            const totalA = results.A.correct + results.A.wrong;
            const totalB = results.B.correct + results.B.wrong;
            const totalC = results.C.correct + results.C.wrong;
            const accuracyA = totalA > 0 ? Math.round((results.A.correct / totalA) * 100) : 0;
            const accuracyB = totalB > 0 ? Math.round((results.B.correct / totalB) * 100) : 0;
            const accuracyC = totalC > 0 ? Math.round((results.C.correct / totalC) * 100) : 0;

            csvContent += `总计${separator}${totalA}${separator}${totalB}${separator}${totalC}\n`;
            csvContent += `正确率${separator}${accuracyA}%${separator}${accuracyB}%${separator}${accuracyC}%\n`;
            csvContent += `挑战模式${separator}${getModeName(gameMode)}\n`;
            csvContent += `难度${separator}${getDifficultyName(difficulty)}\n`;
            csvContent += `分组数量${separator}${groupsCount}\n`;
            csvContent += `时间限制${separator}${parseInt(document.getElementById('gameTime').value) || 30}`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download!== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', '成绩记录.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function getModeName(mode) {
            switch (mode) {
                case 'en-cn':
                    return '英→中';
                case 'cn-en':
                    return '中→英';
                case 'spelling':
                    return '拼写测试';
                default:
                    return '未知模式';
            }
        }

        function getDifficultyName(difficulty) {
            switch (difficulty) {
                case 'easy':
                    return '简单';
                case 'normal':
                    return '普通';
                case 'hard':
                    return '困难';
                default:
                    return '未知难度';
            }
        }

        function updateRemainingWords() {
            if (groupsCount >= 1) {
                const remainingA = document.getElementById('remainingA');
                if (remainingA) {
                    remainingA.textContent = wordsData.length - usedWords.A.length;
                }
            }
            if (groupsCount >= 2) {
                const remainingB = document.getElementById('remainingB');
                if (remainingB) {
                    remainingB.textContent = wordsData.length - usedWords.B.length;
                }
            }
            if (groupsCount >= 3) {
                const remainingC = document.getElementById('remainingC');
                if (remainingC) {
                    remainingC.textContent = wordsData.length - usedWords.C.length;
                }
            }
        }

        function prevQuestion(group) {
            if (currentQuestionIndex[group] > 0) {
                currentQuestionIndex[group]--;
                const prevWord = usedWords[group][currentQuestionIndex[group]];
                currentWords[group] = prevWord;
                setupQuestion(group, prevWord);
                const prevBtn = document.querySelector(`#group${group} .prev-btn`);
                if (prevBtn) {
                    prevBtn.disabled = false;
                }
                const nextBtn = document.querySelector(`#group${group} .next-btn`);
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            } else {
                alert('已经是第一个问题了');
                const prevBtn = document.querySelector(`#group${group} .prev-btn`);
                if (prevBtn) {
                    prevBtn.disabled = true;
                }
            }
        }

        function nextQuestion(group) {
            generateNewQuestion(group);
        }

        function resetGame() {
            // 重置挑战状态
            timeLeft = parseInt(document.getElementById('gameTime').value) || 30;
            results = {
                A: { correct: 0, wrong: 0 },
                B: { correct: 0, wrong: 0 },
                C: { correct: 0, wrong: 0 }
            };
            usedWords = { A: [], B: [], C: [] }; // 重置已使用单词列表
            wordStatus = {}; // 重置单词回答状态
            currentQuestionIndex = { A: -1, B: -1, C: -1 }; // 重置问题索引

            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = `计时：${timeLeft}`;
            }

            const resultA = document.getElementById('resultA');
            if (resultA) {
                resultA.innerHTML = '';
            }
            const resultB = document.getElementById('resultB');
            if (resultB) {
                resultB.innerHTML = '';
            }
            const resultC = document.getElementById('resultC');
            if (resultC) {
                resultC.innerHTML = '';
            }

            updateRemainingWords();
        }

        function startReview() {
            if (!wordsData.length) return alert('请先上传单词文件');

            // 创建新窗口
            const reviewWindow = window.open('', '_blank');
            if (reviewWindow) {
                // 生成复习页面内容
                let reviewContent = '<html><head><title>单词复习</title><style>';
                reviewContent += '.correct { background-color: rgba(144, 238, 144, 0.5); }';
                reviewContent += '.wrong { background-color: rgba(255, 192, 203, 0.5); }';
                reviewContent += '</style></head><body>';

                wordsData.forEach(word => {
                    const status = wordStatus[word.英文];
                    const className = status === true? 'correct' : 'wrong';
                    reviewContent += `<p class="${className}">${word.英文} - ${word.中文}</p>`;
                });

                reviewContent += '</body></html>';

                // 将内容写入新窗口
                reviewWindow.document.write(reviewContent);
                reviewWindow.document.close();
            }
        }

function playSound(word) {
    const synth = window.speechSynthesis;
    let textToSpeak = word;

    if (gameMode === 'cn-en' || gameMode === 'spelling') {
        // 提取中文内容，去除词性等非中文内容
        textToSpeak = textToSpeak.replace(/[a-zA-Z. ]+/g, '');

        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        // 设置中文语言
        utterance.lang = 'zh-CN';

        // 尝试设置高质量的语音引擎（不同浏览器支持的语音引擎可能不同）
        const voices = synth.getVoices();
        for (let i = 0; i < voices.length; i++) {
            if (voices[i].lang === 'zh-CN') {
                // 你可以根据需要选择特定的语音引擎
                utterance.voice = voices[i];
                break;
            }
        }

        // 设置音量（范围从 0 到 1）
        utterance.volume = 1;

        synth.speak(utterance);
    } else if (gameMode === 'en-cn' || gameMode === 'spelling') {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        synth.speak(utterance);
    }
}

    </script>
</body>

</html>
